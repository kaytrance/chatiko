var app=angular.module("myApp",[]);app.controller("roomCtrl",["$scope","$http",function(e,o){function t(){$("#chat").animate({scrollTop:$("#chat ul").height()},"slow")}function n(o,t){var n={user:o,isOut:!1,tick:"",time:l(),color:null,message:t,isMessage:!1};e.messages.push(n),s()}function s(){document.hasFocus()||(clearInterval(f),f=setInterval(function(){a()},1e3))}function c(){clearInterval(f),document.title='joined room "'+m+'"'}function a(){document.title!==d?document.title=d:document.title='joined room "'+m+'"',document.hasFocus()&&c()}function i(o,t){var t="object"==typeof o?0:1,n=t?" << ":" >> ",s={user:o.user,isOut:t,tick:n,time:l(),color:o.color,message:o.message,isMessage:!0},c={user:g,isOut:t,tick:n,time:l(),color:p,message:e.mymessage,isMessage:!0};return t?c:s}function r(e){return"hsl("+e+",67%,61%)"}function l(){var e=new Date,o=e.getHours(),t=e.getMinutes();return o=10>o?"0"+o:o,t=10>t?"0"+t:t,"["+o+":"+t+"]"}e.socket=io("/gateway"),e.socket.nickname="tetsss";var m=window.location.href.split("/")[4],u=window.location.href.split("/")[5],g=$("#user").text(),p=parseInt(250*Math.random());e.messages=[];var f=null,d="****";e.canChat=!1,e.socket.emit("join",{room_id:m,token:u,user_name:g}),e.socket.emit("history"),e.socket.on("history",function(o){null===o.messages?setTimeout(function(){e.socket.emit("history")},3e3):(e.messages=o.messages.concat(e.messages),e.$apply(),t())}),e.socket.on("message",function(o){console.log("mesage received",o),e.messages.push(i(o)),s(),e.$apply(),t()}),e.socket.on("notification",function(o){console.log("notification received",o),n(o.user,o.message),e.$apply(),t()}),e.socket.on("disconnect",function(o){console.log("disconnected"),n("","disconnected from room :("),c(),e.canChat=!1,e.$apply(),t()}),e.socket.on("reconnect_attempt",function(o){console.log("reconnect_attempt",o),n("","attempting to reconnect.."),e.canChat=!1,e.$apply(),t()}),e.socket.on("reconnect_failed",function(){console.log("reconnect_failed"),n("","failed to reconnect. Please refresh the page!"),e.canChat=!1,e.$apply(),t()}),e.socket.on("reconnect",function(){var o=window.location.href.split("/")[4];console.log("reconnect at",o),n("","YES! Successfully reconnected!"),e.socket.emit("join",{room_id:o,token:u,user_name:g}),e.canChat=!0,e.$apply(),t()}),e.socket.on("connect",function(){console.log("room connected"),e.canChat=!0}),e.sendMessage=function(o){13===o.keyCode&&("/color"===e.mymessage.toLowerCase()?(e.mymessage="",o.preventDefault(),p=parseInt(250*Math.random(),10),e.socket.emit("change color",{user:g,color:p}),t()):"/clear"===e.mymessage.toLowerCase()?(e.messages=[],e.mymessage="",o.preventDefault(),t()):(e.socket.emit("message",{message:e.mymessage,user:g,color:p,token:u}),e.messages.push(i(e.mymessage)),e.mymessage="",o.preventDefault(),t()))},e.getStyle=function(e){return null!==e?{"border-left":"5px solid "+r(e)}:{}},$(window).resize(function(){t()})}]);